{% extends 'core/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %}{% if object %}Editar Compra{% else %}Nueva Compra{% endif %}{% endblock %}

{% block content %}

<div class="card shadow-sm">
  <div class="card-body">
    <h2 class="mb-4">{% if object %}Editar Compra #{{ object.id }}{% else %}Nueva Compra{% endif %}</h2>

    <form method="post">
      {% csrf_token %}
      
      <div class="card mb-4">
        <div class="card-header">Datos de la Compra</div>
        <div class="card-body">
          {{ form|crispy }}
        </div>
      </div>

      <div class="card">
        <div class="card-header">Items de la Compra</div>
        <div class="card-body">
          
          {{ formset.management_form }}
          
          <table class="table" id="items-table">
            <thead class="table-light">
              <tr>
                <th style="width: 50%;">Producto</th>
                <th style="width: 20%;">Cantidad</th>
                <th style="width: 20%;">Costo</th>
                <th style="width: 10%;">Eliminar</th>
              </tr>
            </thead>
            <tbody id="formset-container">
              {% for item_form in formset %}
              <tr class="item-form-row">
                <td>{{ item_form.producto|as_crispy_field }}</td>
                <td>{{ item_form.cantidad|as_crispy_field }}</td>
                <td>{{ item_form.precio_costo|as_crispy_field }}</td>
                <td class="text-center align-middle">
                  {% if item_form.instance.pk %}
                    {{ item_form.DELETE }}
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
          <template id="item-form-template">
            <tr class="item-form-row">
              <td>{{ formset.empty_form.producto|as_crispy_field }}</td>
              <td>{{ formset.empty_form.cantidad|as_crispy_field }}</td>
              <td>{{ formset.empty_form.precio_costo|as_crispy_field }}</td>
              <td class="text-center align-middle">
                <button type="button" class="btn btn-danger btn-sm remove-form-row">Quitar</button>
              </td>
            </tr>
          </template>

          <button type="button" id="add-form-row" class="btn btn-success btn-sm mt-2">AÃ±adir Item</button>
        </div>
      </div>

      <div class="mt-4">
        <button type="submit" class="btn btn-primary">Guardar Compra</button>
        <a href="{% url 'compra-list' %}" class="btn btn-secondary">Cancelar</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('formset-container');
    const template = document.getElementById('item-form-template');
    const totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
    
    document.getElementById('add-form-row').addEventListener('click', function() {
        let formIndex = parseInt(totalFormsInput.value);
        let newRowHtml = template.innerHTML.replace(/__prefix__/g, formIndex);
        
        let tempDiv = document.createElement('tbody');
        tempDiv.innerHTML = newRowHtml;
        let newRow = tempDiv.firstElementChild;

        container.appendChild(newRow);
        totalFormsInput.value = formIndex + 1;
    });

    container.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-form-row')) {
            e.target.closest('.item-form-row').remove();
        }
    });
});
</script>
{% endblock %}